{% extends "base.html" %}

{% block title %}Gerenciar Usuários - Period Grade System{% endblock %}
{% block page_title %}Gerenciar Usuários{% endblock %}
{% block page_subtitle %}Administrar usuários do sistema{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">Usuários do Sistema</h2>
        <p class="text-muted mb-0">Gerencie usuários, papéis e permissões</p>
    </div>
    <button class="btn btn-primary" onclick="showCreateUserModal()">
        <i class="bi bi-person-plus me-2"></i>Novo Usuário
    </button>
</div>

<!-- Users Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title mb-0">Lista de Usuários</h3>
    </div>
    <div class="card-body p-0">
        <div class="table-container">
            <table class="table" id="usersTable">
                <thead>
                    <tr>
                        <th>Nome Completo</th>
                        <th>Usuário</th>
                        <th>Email</th>
                        <th>Papel</th>
                        <th>Criado em</th>
                        <th width="120">Ações</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="spinner me-2"></div>
                            Carregando usuários...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">Novo Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    
                    <div class="form-group">
                        <label for="fullName" class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="fullName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="username" class="form-label">Usuário</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="role" class="form-label">Papel</label>
                        <select class="form-control form-select" id="role" required>
                            <option value="">Selecione um papel</option>
                            <option value="admin">Administrador</option>
                            <option value="coordinator">Coordenador</option>
                            <option value="professor">Professor</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="passwordGroup">
                        <label for="password" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="password" required>
                        <small class="text-muted">Mínimo 6 caracteres</small>
                    </div>
                    
                    <div class="form-group" id="passwordConfirmGroup" style="display: none;">
                        <label class="form-label">
                            <input type="checkbox" id="changePassword" onchange="togglePasswordField()">
                            Alterar senha
                        </label>
                    </div>
                </form>
                
                <div id="userModalMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">
                    <span id="saveUserText">Salvar</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este usuário?</p>
                <p class="text-muted mb-0">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteUser()">Excluir</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let users = [];
let editingUserId = null;
let deletingUserId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});

async function loadUsers() {
    try {
        const response = await fetch('/api/users');
        users = await response.json();
        renderUsersTable();
    } catch (error) {
        console.error('Erro ao carregar usuários:', error);
        showMessage('Erro ao carregar usuários', 'danger');
    }
}

function renderUsersTable() {
    const tbody = document.getElementById('usersTableBody');
    
    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="bi bi-people" style="font-size: 2rem; color: var(--color-gray-400);"></i>
                    <div class="mt-2">Nenhum usuário encontrado</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>${user.full_name}</td>
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td>
                <span class="badge badge-${getRoleBadgeClass(user.role)}">
                    ${getRoleDisplayName(user.role)}
                </span>
            </td>
            <td>${formatDate(user.created_at)}</td>
            <td>
                <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-ghost" onclick="editUser(${user.id})" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-ghost" onclick="deleteUser(${user.id})" title="Excluir">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getRoleBadgeClass(role) {
    const classes = {
        'admin': 'primary',
        'coordinator': 'secondary',
        'professor': 'outline'
    };
    return classes[role] || 'outline';
}

function getRoleDisplayName(role) {
    const names = {
        'admin': 'Administrador',
        'coordinator': 'Coordenador', 
        'professor': 'Professor'
    };
    return names[role] || role;
}

function showCreateUserModal() {
    editingUserId = null;
    document.getElementById('userModalTitle').textContent = 'Novo Usuário';
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('passwordGroup').style.display = 'block';
    document.getElementById('passwordConfirmGroup').style.display = 'none';
    document.getElementById('password').required = true;
    document.getElementById('saveUserText').textContent = 'Criar Usuário';
    clearMessage('userModalMessage');
    
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
}

function editUser(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;
    
    editingUserId = userId;
    document.getElementById('userModalTitle').textContent = 'Editar Usuário';
    document.getElementById('userId').value = user.id;
    document.getElementById('fullName').value = user.full_name;
    document.getElementById('username').value = user.username;
    document.getElementById('email').value = user.email;
    document.getElementById('role').value = user.role;
    document.getElementById('password').value = '';
    document.getElementById('passwordGroup').style.display = 'none';
    document.getElementById('passwordConfirmGroup').style.display = 'block';
    document.getElementById('changePassword').checked = false;
    document.getElementById('password').required = false;
    document.getElementById('saveUserText').textContent = 'Atualizar Usuário';
    clearMessage('userModalMessage');
    
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
}

function togglePasswordField() {
    const changePassword = document.getElementById('changePassword').checked;
    const passwordGroup = document.getElementById('passwordGroup');
    const passwordField = document.getElementById('password');
    
    if (changePassword) {
        passwordGroup.style.display = 'block';
        passwordField.required = true;
    } else {
        passwordGroup.style.display = 'none';
        passwordField.required = false;
        passwordField.value = '';
    }
}

async function saveUser() {
    const form = document.getElementById('userForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const userData = {
        full_name: document.getElementById('fullName').value,
        username: document.getElementById('username').value,
        email: document.getElementById('email').value,
        role: document.getElementById('role').value
    };
    
    const password = document.getElementById('password').value;
    if (password) {
        userData.password = password;
    }
    
    const saveBtn = document.querySelector('[onclick="saveUser()"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<div class="spinner spinner-sm me-2"></div>Salvando...';
    saveBtn.disabled = true;
    
    try {
        const url = editingUserId ? `/api/users/${editingUserId}` : '/api/users';
        const method = editingUserId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showMessage(result.message, 'success', 'userModalMessage');
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
                modal.hide();
                loadUsers();
            }, 1500);
        } else {
            showMessage(result.error, 'danger', 'userModalMessage');
        }
    } catch (error) {
        console.error('Erro ao salvar usuário:', error);
        showMessage('Erro ao salvar usuário', 'danger', 'userModalMessage');
    }
    
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
}

function deleteUser(userId) {
    deletingUserId = userId;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

async function confirmDeleteUser() {
    if (!deletingUserId) return;
    
    try {
        const response = await fetch(`/api/users/${deletingUserId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showMessage(result.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            loadUsers();
        } else {
            showMessage(result.error, 'danger');
        }
    } catch (error) {
        console.error('Erro ao excluir usuário:', error);
        showMessage('Erro ao excluir usuário', 'danger');
    }
    
    deletingUserId = null;
}

function showMessage(message, type, elementId = 'main') {
    const alertClass = type === 'danger' ? 'alert-danger' : 'alert-success';
    const icon = type === 'danger' ? 'bi-exclamation-triangle' : 'bi-check-circle';
    
    const html = `
        <div class="alert ${alertClass}">
            <i class="bi ${icon} me-2"></i>${message}
        </div>
    `;
    
    if (elementId === 'main') {
        // Show in main content area
        const contentArea = document.querySelector('.content-area');
        const existingAlert = contentArea.querySelector('.alert');
        if (existingAlert) existingAlert.remove();
        contentArea.insertAdjacentHTML('afterbegin', html);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            const alert = contentArea.querySelector('.alert');
            if (alert) alert.remove();
        }, 5000);
    } else {
        document.getElementById(elementId).innerHTML = html;
    }
}

function clearMessage(elementId) {
    document.getElementById(elementId).innerHTML = '';
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('pt-BR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}
</script>
{% endblock %}
