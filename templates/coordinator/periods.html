{% extends "base.html" %}

{% block title %}Meus Períodos - Period Grade System{% endblock %}
{% block page_title %}Meus Períodos{% endblock %}
{% block page_subtitle %}Gerencie seus períodos acadêmicos{% endblock %}

{% block content %}
<div class="mb-4">
    <h2 class="mb-1">Períodos Acadêmicos</h2>
    <p class="text-muted mb-0">Selecione um período para gerenciar estudantes e módulos</p>
</div>

<!-- Periods Grid -->
<div id="periodsContainer">
    <div class="loading text-center py-5">
        <div class="spinner me-2"></div>
        <span>Carregando períodos...</span>
    </div>
</div>

<!-- Period Management Section -->
<div id="periodManagement" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-1" id="selectedPeriodName">Período Selecionado</h3>
            <p class="text-muted mb-0">Gerencie estudantes e módulos deste período</p>
        </div>
        <button class="btn btn-secondary" onclick="backToPeriods()">
            <i class="bi bi-arrow-left me-2"></i>Voltar aos Períodos
        </button>
    </div>

    <!-- Management Tabs -->
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students-pane" type="button">
                        <i class="bi bi-mortarboard me-1"></i>Estudantes
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="modules-tab" data-bs-toggle="tab" data-bs-target="#modules-pane" type="button">
                        <i class="bi bi-book me-1"></i>Módulos
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="enrollments-tab" data-bs-toggle="tab" data-bs-target="#enrollments-pane" type="button">
                        <i class="bi bi-list-check me-1"></i>Matrículas
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <!-- Students Tab -->
                <div class="tab-pane fade show active" id="students-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">Estudantes</h4>
                        <button class="btn btn-primary" onclick="showCreateStudentModal()">
                            <i class="bi bi-person-plus me-1"></i>Novo Estudante
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="table" id="studentsTable">
                            <thead>
                                <tr>
                                    <th>Matrícula</th>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Data Matrícula</th>
                                    <th>Atestados</th>
                                    <th width="100">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <tr>
                                    <td colspan="6" class="text-center py-3">Selecione um período para ver os estudantes</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Modules Tab -->
                <div class="tab-pane fade" id="modules-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">Módulos</h4>
                        <div>
                            <a href="#" onclick="goToModules()" class="btn btn-primary">
                                <i class="bi bi-gear me-1"></i>Gerenciar Módulos
                            </a>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table" id="modulesTable">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Nome</th>
                                    <th>Professor</th>
                                    <th>Créditos</th>
                                    <th>Max. Faltas</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="modulesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center py-3">Carregando módulos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Enrollments Tab -->
                <div class="tab-pane fade" id="enrollments-pane">
                    <div class="mb-3">
                        <h4 class="mb-1">Matrículas</h4>
                        <p class="text-muted mb-0">Gerencie as matrículas dos estudantes nos módulos</p>
                    </div>
                    
                    <div id="enrollmentsContent">
                        <div class="text-center py-4">
                            <p class="text-muted">Selecione um período para gerenciar matrículas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Student Modal -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="studentModalTitle">Novo Estudante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <input type="hidden" id="studentId">
                    <div class="form-group mb-3">
                        <label for="studentNumber" class="form-label">Número de Matrícula *</label>
                        <input type="text" class="form-control" id="studentNumber" required
                               placeholder="Ex: 20241001">
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="studentName" class="form-label">Nome Completo *</label>
                        <input type="text" class="form-control" id="studentName" required
                               placeholder="Nome completo do estudante">
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="studentEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="studentEmail"
                               placeholder="email@exemplo.com">
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="enrollmentDate" class="form-label">Data de Matrícula *</label>
                        <input type="date" class="form-control" id="enrollmentDate" required>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="medicalCertificates" class="form-label">Atestados Médicos</label>
                        <input type="number" class="form-control" id="medicalCertificates" 
                               min="0" value="0">
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="referralInfo" class="form-label">Informações de Encaminhamento</label>
                        <input type="text" class="form-control" id="referralInfo"
                               placeholder="Informações sobre encaminhamento">
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="observations" class="form-label">Observações</label>
                        <textarea class="form-control" id="observations" rows="3"
                                  placeholder="Observações sobre o estudante"></textarea>
                    </div>
                </form>
                
                <div id="studentModalMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveStudent()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este estudante? Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteStudent()">Excluir</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPeriodId = null;
let periods = [];
let students = [];
let modules = [];
let studentToDelete = null;

document.addEventListener('DOMContentLoaded', function() {
    loadPeriods();
    
    // Set default enrollment date to today
    document.getElementById('enrollmentDate').value = new Date().toISOString().split('T')[0];
});

async function loadPeriods() {
    try {
        const response = await fetch('/api/coordinator/periods');
        periods = await response.json();
        renderPeriodsGrid();
    } catch (error) {
        console.error('Erro ao carregar períodos:', error);
        showMessage('Erro ao carregar períodos', 'danger');
    }
}

function renderPeriodsGrid() {
    const container = document.getElementById('periodsContainer');
    
    if (periods.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-calendar-range" style="font-size: 3rem; color: var(--color-gray-400);"></i>
                <h3 class="mt-3">Nenhum período encontrado</h3>
                <p class="text-muted">Você ainda não tem períodos acadêmicos atribuídos.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="quick-actions">
            ${periods.map(period => `
                <div class="quick-action" onclick="selectPeriod(${period.id}, '${period.name}')">
                    <div class="quick-action-icon">
                        <i class="bi bi-calendar-${period.is_active ? 'check' : 'x'}"></i>
                    </div>
                    <div class="quick-action-title">${period.name}</div>
                    <div class="quick-action-desc">
                        ${formatDate(period.start_date)} - ${formatDate(period.end_date)}
                        <br>
                        <span class="badge badge-${period.is_active ? 'primary' : 'secondary'} mt-1">
                            ${period.is_active ? 'Ativo' : 'Inativo'}
                        </span>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function selectPeriod(periodId, periodName) {
    currentPeriodId = periodId;
    document.getElementById('selectedPeriodName').textContent = periodName;
    document.getElementById('periodsContainer').style.display = 'none';
    document.getElementById('periodManagement').style.display = 'block';
    
    loadStudents();
    loadModules();
}

function backToPeriods() {
    currentPeriodId = null;
    document.getElementById('periodsContainer').style.display = 'block';
    document.getElementById('periodManagement').style.display = 'none';
}

async function loadStudents() {
    if (!currentPeriodId) return;
    
    try {
        const response = await fetch(`/api/periods/${currentPeriodId}/students`);
        students = await response.json();
        renderStudentsTable();
    } catch (error) {
        console.error('Erro ao carregar estudantes:', error);
        showMessage('Erro ao carregar estudantes', 'danger');
    }
}

function renderStudentsTable() {
    const tbody = document.getElementById('studentsTableBody');
    
    if (students.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-3">
                    <i class="bi bi-mortarboard" style="font-size: 1.5rem; color: var(--color-gray-400);"></i>
                    <div class="mt-1">Nenhum estudante cadastrado</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = students.map(student => `
        <tr>
            <td><strong>${student.student_number}</strong></td>
            <td>${student.full_name}</td>
            <td>${student.email || '-'}</td>
            <td>${formatDate(student.enrollment_date)}</td>
            <td>
                <span class="badge badge-${student.medical_certificates > 3 ? 'outline' : 'secondary'}">
                    ${student.medical_certificates}
                </span>
            </td>
            <td>
                <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-ghost" onclick="editStudent(${student.id})" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-ghost" onclick="deleteStudent(${student.id})" title="Excluir">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function showCreateStudentModal() {
    if (!currentPeriodId) {
        showMessage('Selecione um período primeiro', 'warning');
        return;
    }
    
    document.getElementById('studentModalTitle').textContent = 'Novo Estudante';
    document.getElementById('studentForm').reset();
    document.getElementById('studentId').value = '';
    document.getElementById('enrollmentDate').value = new Date().toISOString().split('T')[0];
    clearMessage('studentModalMessage');
    
    const modal = new bootstrap.Modal(document.getElementById('studentModal'));
    modal.show();
}

async function saveStudent() {
    const form = document.getElementById('studentForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const studentId = document.getElementById('studentId').value;
    const studentData = {
        student_number: document.getElementById('studentNumber').value,
        full_name: document.getElementById('studentName').value,
        email: document.getElementById('studentEmail').value,
        enrollment_date: document.getElementById('enrollmentDate').value,
        medical_certificates: parseInt(document.getElementById('medicalCertificates').value) || 0,
        referral_info: document.getElementById('referralInfo').value,
        observations: document.getElementById('observations').value
    };
    
    try {
        const url = studentId ? 
            `/api/coordinator/students/${studentId}` : 
            `/api/periods/${currentPeriodId}/students`;
        
        const method = studentId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(studentData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showMessage(result.message, 'success', 'studentModalMessage');
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('studentModal'));
                modal.hide();
                loadStudents();
            }, 1500);
        } else {
            showMessage(result.error, 'danger', 'studentModalMessage');
        }
    } catch (error) {
        console.error('Erro ao salvar estudante:', error);
        showMessage('Erro ao salvar estudante', 'danger', 'studentModalMessage');
    }
}

function showMessage(message, type, elementId = 'main') {
    const alertClass = type === 'danger' ? 'alert-danger' : type === 'warning' ? 'alert-warning' : 'alert-success';
    const icon = type === 'danger' ? 'bi-exclamation-triangle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-check-circle';
    
    const html = `
        <div class="alert ${alertClass}">
            <i class="bi ${icon} me-2"></i>${message}
        </div>
    `;
    
    if (elementId === 'main') {
        const contentArea = document.querySelector('.content-area');
        const existingAlert = contentArea.querySelector('.alert');
        if (existingAlert) existingAlert.remove();
        contentArea.insertAdjacentHTML('afterbegin', html);
        
        setTimeout(() => {
            const alert = contentArea.querySelector('.alert');
            if (alert) alert.remove();
        }, 5000);
    } else {
        document.getElementById(elementId).innerHTML = html;
    }
}

function clearMessage(elementId) {
    document.getElementById(elementId).innerHTML = '';
}

function formatDate(dateString) {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleDateString('pt-BR');
}

// Carregar módulos do período
async function loadModules() {
    if (!currentPeriodId) return;
    
    try {
        const response = await fetch(`/api/coordinator/periods/${currentPeriodId}/modules`);
        modules = await response.json();
        renderModulesTable();
    } catch (error) {
        console.error('Erro ao carregar módulos:', error);
        showMessage('Erro ao carregar módulos', 'danger');
    }
}

function renderModulesTable() {
    const tbody = document.getElementById('modulesTableBody');
    
    if (modules.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-3">
                    <i class="bi bi-book" style="font-size: 1.5rem; color: var(--color-gray-400);"></i>
                    <div class="mt-1">Nenhum módulo cadastrado</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = modules.map(module => `
        <tr>
            <td><strong>${module.code}</strong></td>
            <td>${module.name}</td>
            <td>${module.professor_name}</td>
            <td>${module.credits}</td>
            <td>${module.max_absences}</td>
            <td>
                <span class="badge ${module.is_active ? 'bg-success' : 'bg-secondary'}">
                    ${module.is_active ? 'Ativo' : 'Inativo'}
                </span>
            </td>
        </tr>
    `).join('');
}

// Editar estudante
async function editStudent(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) {
        showMessage('Estudante não encontrado', 'danger');
        return;
    }
    
    document.getElementById('studentModalTitle').textContent = 'Editar Estudante';
    document.getElementById('studentId').value = student.id;
    document.getElementById('studentNumber').value = student.student_number;
    document.getElementById('studentName').value = student.full_name;
    document.getElementById('studentEmail').value = student.email || '';
    document.getElementById('enrollmentDate').value = student.enrollment_date;
    document.getElementById('medicalCertificates').value = student.medical_certificates || 0;
    document.getElementById('referralInfo').value = student.referral_info || '';
    document.getElementById('observations').value = student.observations || '';
    
    clearMessage('studentModalMessage');
    
    const modal = new bootstrap.Modal(document.getElementById('studentModal'));
    modal.show();
}

// Excluir estudante
function deleteStudent(studentId) {
    studentToDelete = studentId;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

async function confirmDeleteStudent() {
    if (!studentToDelete) return;
    
    try {
        const response = await fetch(`/api/coordinator/students/${studentToDelete}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showMessage('Estudante excluído com sucesso!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            loadStudents();
        } else {
            const result = await response.json();
            showMessage(result.error || 'Erro ao excluir estudante', 'danger');
        }
    } catch (error) {
        console.error('Erro ao excluir estudante:', error);
        showMessage('Erro ao excluir estudante', 'danger');
    }
    
    studentToDelete = null;
}

// Navegar para a página de gerenciamento de módulos
function goToModules() {
    if (currentPeriodId) {
        window.location.href = `/coordinator/period/${currentPeriodId}/modules`;
    }
}
</script>
{% endblock %}
