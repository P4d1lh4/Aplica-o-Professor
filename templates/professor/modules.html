{% extends "base.html" %}

{% block title %}Meus Módulos - Period Grade System{% endblock %}
{% block page_title %}Meus Módulos{% endblock %}
{% block page_subtitle %}Gerencie suas turmas e notas{% endblock %}

{% block content %}
<div class="mb-4">
    <h2 class="mb-1">Módulos de Ensino</h2>
    <p class="text-muted mb-0">Selecione um módulo para gerenciar notas e frequência</p>
</div>

<!-- Modules Grid -->
<div id="modulesContainer">
    <div class="loading text-center py-5">
        <div class="spinner me-2"></div>
        <span>Carregando módulos...</span>
    </div>
</div>

<!-- Module Management Section -->
<div id="moduleManagement" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-1" id="selectedModuleName">Módulo Selecionado</h3>
            <p class="text-muted mb-0" id="selectedModulePeriod">Período</p>
        </div>
        <button class="btn btn-secondary" onclick="backToModules()">
            <i class="bi bi-arrow-left me-2"></i>Voltar aos Módulos
        </button>
    </div>

    <!-- Students and Grades -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="bi bi-mortarboard me-2"></i>Estudantes e Notas
                </h4>
                <button class="btn btn-outline" onclick="exportGrades()">
                    <i class="bi bi-download me-1"></i>Exportar
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-container">
                <table class="table" id="gradesTable">
                    <thead>
                        <tr>
                            <th>Matrícula</th>
                            <th>Nome</th>
                            <th>Faltas</th>
                            <th>Nota Tutor</th>
                            <th>Avaliação</th>
                            <th>Recuperação</th>
                            <th>Final</th>
                            <th>Status</th>
                            <th width="100">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="gradesTableBody">
                        <tr>
                            <td colspan="9" class="text-center py-3">Selecione um módulo para ver os estudantes</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Grades Modal -->
<div class="modal fade" id="gradesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square me-2"></i>
                    Editar Notas - <span id="editingStudentName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="gradesForm">
                    <input type="hidden" id="editingEnrollmentId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="absences" class="form-label">
                                    <i class="bi bi-calendar-x me-1"></i>Faltas
                                </label>
                                <input type="number" class="form-control" id="absences" 
                                       min="0" max="50" required>
                                <small class="form-text text-muted">Número total de faltas</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="tutorGrade" class="form-label">
                                    <i class="bi bi-star me-1"></i>Nota do Tutor
                                </label>
                                <input type="number" class="form-control" id="tutorGrade" 
                                       min="0" max="10" step="0.1" required>
                                <small class="form-text text-muted">0.0 - 10.0</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="regularGrade" class="form-label">
                                    <i class="bi bi-clipboard-check me-1"></i>Avaliação Regular
                                </label>
                                <input type="number" class="form-control" id="regularGrade" 
                                       min="0" max="10" step="0.1" required>
                                <small class="form-text text-muted">Prova/avaliação principal</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="makeupGrade" class="form-label">
                                    <i class="bi bi-arrow-repeat me-1"></i>Recuperação
                                </label>
                                <input type="number" class="form-control" id="makeupGrade" 
                                       min="0" max="10" step="0.1">
                                <small class="form-text text-muted">Deixe vazio se não fez</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="finalGrade" class="form-label">
                            <i class="bi bi-trophy me-1"></i>Nota Final
                        </label>
                        <input type="number" class="form-control" id="finalGrade" 
                               min="0" max="10" step="0.1" required>
                        <small class="form-text text-muted">Nota final considerando todas as avaliações</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Critérios de Aprovação:</strong><br>
                        • Nota final ≥ 7.0: Aprovado<br>
                        • Nota final 5.0 - 6.9: Recuperação<br>
                        • Nota final < 5.0: Reprovado
                    </div>
                </form>
                
                <div id="gradesModalMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveGrades()">
                    <span id="saveGradesText">Salvar Notas</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Grade Entry Modal -->
<div class="modal fade" id="quickGradeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Lançamento Rápido de Notas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Aplique a mesma nota para todos os estudantes selecionados</p>
                
                <form id="quickGradeForm">
                    <div class="form-group">
                        <label for="quickGradeType" class="form-label">Tipo de Nota</label>
                        <select class="form-control form-select" id="quickGradeType" required>
                            <option value="">Selecione o tipo</option>
                            <option value="tutor_grade">Nota do Tutor</option>
                            <option value="regular_exam_grade">Avaliação Regular</option>
                            <option value="makeup_exam_grade">Recuperação</option>
                            <option value="final_grade">Nota Final</option>
                            <option value="absences">Faltas</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="quickGradeValue" class="form-label">Valor</label>
                        <input type="number" class="form-control" id="quickGradeValue" 
                               min="0" max="10" step="0.1" required>
                    </div>
                </form>
                
                <div id="quickGradeMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="applyQuickGrade()">Aplicar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentModuleId = null;
let modules = [];
let students = [];
let selectedStudents = [];

document.addEventListener('DOMContentLoaded', function() {
    loadModules();
});

async function loadModules() {
    try {
        const response = await fetch('/api/professor/modules');
        modules = await response.json();
        renderModulesGrid();
    } catch (error) {
        console.error('Erro ao carregar módulos:', error);
        showMessage('Erro ao carregar módulos', 'danger');
    }
}

function renderModulesGrid() {
    const container = document.getElementById('modulesContainer');
    
    if (modules.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-book" style="font-size: 3rem; color: var(--color-gray-400);"></i>
                <h3 class="mt-3">Nenhum módulo encontrado</h3>
                <p class="text-muted">Você ainda não tem módulos atribuídos.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="quick-actions">
            ${modules.map(module => `
                <div class="quick-action" onclick="selectModule(${module.id}, '${module.name}', '${module.period_name}')">
                    <div class="quick-action-icon">
                        <i class="bi bi-book-fill"></i>
                    </div>
                    <div class="quick-action-title">${module.name}</div>
                    <div class="quick-action-desc">
                        <strong>Código:</strong> ${module.code}<br>
                        <strong>Período:</strong> ${module.period_name}<br>
                        <span class="badge badge-outline mt-1">
                            ${module.credits} créditos
                        </span>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function selectModule(moduleId, moduleName, periodName) {
    currentModuleId = moduleId;
    document.getElementById('selectedModuleName').textContent = moduleName;
    document.getElementById('selectedModulePeriod').textContent = periodName;
    document.getElementById('modulesContainer').style.display = 'none';
    document.getElementById('moduleManagement').style.display = 'block';
    
    loadStudents();
}

function backToModules() {
    currentModuleId = null;
    document.getElementById('modulesContainer').style.display = 'block';
    document.getElementById('moduleManagement').style.display = 'none';
}

async function loadStudents() {
    if (!currentModuleId) return;
    
    try {
        const response = await fetch(`/api/modules/${currentModuleId}/students`);
        students = await response.json();
        renderGradesTable();
    } catch (error) {
        console.error('Erro ao carregar estudantes:', error);
        showMessage('Erro ao carregar estudantes', 'danger');
    }
}

function renderGradesTable() {
    const tbody = document.getElementById('gradesTableBody');
    
    if (students.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-3">
                    <i class="bi bi-mortarboard" style="font-size: 1.5rem; color: var(--color-gray-400);"></i>
                    <div class="mt-1">Nenhum estudante matriculado</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = students.map(student => {
        const finalGrade = student.final_grade || 0;
        const status = getGradeStatus(finalGrade);
        
        return `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input me-2" 
                           value="${student.enrollment_id}" onchange="toggleStudentSelection(this)">
                    <strong>${student.student_number}</strong>
                </td>
                <td>${student.full_name}</td>
                <td>
                    <span class="badge badge-${student.absences > 5 ? 'outline' : 'secondary'}">
                        ${student.absences || 0}
                    </span>
                </td>
                <td>${formatGrade(student.tutor_grade)}</td>
                <td>${formatGrade(student.regular_exam_grade)}</td>
                <td>${formatGrade(student.makeup_exam_grade)}</td>
                <td>
                    <span class="badge badge-${status.class}">
                        ${formatGrade(finalGrade)}
                    </span>
                </td>
                <td>
                    <span class="badge badge-${status.class}">
                        ${status.text}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-ghost" 
                            onclick="editGrades('${student.enrollment_id}', '${student.full_name}')" 
                            title="Editar notas">
                        <i class="bi bi-pencil"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function getGradeStatus(grade) {
    if (grade >= 7.0) {
        return { class: 'primary', text: 'Aprovado' };
    } else if (grade >= 5.0) {
        return { class: 'secondary', text: 'Recuperação' };
    } else {
        return { class: 'outline', text: 'Reprovado' };
    }
}

function formatGrade(grade) {
    if (grade === null || grade === undefined || grade === 0) return '-';
    return parseFloat(grade).toFixed(1);
}

function toggleStudentSelection(checkbox) {
    const enrollmentId = checkbox.value;
    if (checkbox.checked) {
        selectedStudents.push(enrollmentId);
    } else {
        selectedStudents = selectedStudents.filter(id => id !== enrollmentId);
    }
    
    // Show/hide quick grade button
    const quickGradeBtn = document.getElementById('quickGradeBtn');
    if (quickGradeBtn) {
        quickGradeBtn.style.display = selectedStudents.length > 0 ? 'block' : 'none';
    }
}

function editGrades(enrollmentId, studentName) {
    const student = students.find(s => s.enrollment_id == enrollmentId);
    if (!student) return;
    
    document.getElementById('editingEnrollmentId').value = enrollmentId;
    document.getElementById('editingStudentName').textContent = studentName;
    document.getElementById('absences').value = student.absences || 0;
    document.getElementById('tutorGrade').value = student.tutor_grade || '';
    document.getElementById('regularGrade').value = student.regular_exam_grade || '';
    document.getElementById('makeupGrade').value = student.makeup_exam_grade || '';
    document.getElementById('finalGrade').value = student.final_grade || '';
    
    clearMessage('gradesModalMessage');
    
    const modal = new bootstrap.Modal(document.getElementById('gradesModal'));
    modal.show();
}

async function saveGrades() {
    const form = document.getElementById('gradesForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const enrollmentId = document.getElementById('editingEnrollmentId').value;
    const gradesData = {
        absences: parseInt(document.getElementById('absences').value) || 0,
        tutor_grade: parseFloat(document.getElementById('tutorGrade').value) || 0,
        regular_exam_grade: parseFloat(document.getElementById('regularGrade').value) || 0,
        makeup_exam_grade: parseFloat(document.getElementById('makeupGrade').value) || 0,
        final_grade: parseFloat(document.getElementById('finalGrade').value) || 0
    };
    
    const saveBtn = document.querySelector('[onclick="saveGrades()"]');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<div class="spinner spinner-sm me-2"></div>Salvando...';
    saveBtn.disabled = true;
    
    try {
        const response = await fetch(`/api/grades/${enrollmentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(gradesData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showMessage(result.message, 'success', 'gradesModalMessage');
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('gradesModal'));
                modal.hide();
                loadStudents();
            }, 1500);
        } else {
            showMessage(result.error, 'danger', 'gradesModalMessage');
        }
    } catch (error) {
        console.error('Erro ao salvar notas:', error);
        showMessage('Erro ao salvar notas', 'danger', 'gradesModalMessage');
    }
    
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
}

function showQuickGradeModal() {
    if (selectedStudents.length === 0) {
        showMessage('Selecione pelo menos um estudante', 'warning');
        return;
    }
    
    document.getElementById('quickGradeForm').reset();
    clearMessage('quickGradeMessage');
    
    const modal = new bootstrap.Modal(document.getElementById('quickGradeModal'));
    modal.show();
}

async function applyQuickGrade() {
    const form = document.getElementById('quickGradeForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const gradeType = document.getElementById('quickGradeType').value;
    const gradeValue = parseFloat(document.getElementById('quickGradeValue').value);
    
    // Apply to all selected students
    for (const enrollmentId of selectedStudents) {
        const student = students.find(s => s.enrollment_id == enrollmentId);
        if (student) {
            const gradesData = {
                absences: student.absences || 0,
                tutor_grade: student.tutor_grade || 0,
                regular_exam_grade: student.regular_exam_grade || 0,
                makeup_exam_grade: student.makeup_exam_grade || 0,
                final_grade: student.final_grade || 0
            };
            
            gradesData[gradeType] = gradeValue;
            
            try {
                await fetch(`/api/grades/${enrollmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gradesData)
                });
            } catch (error) {
                console.error(`Erro ao atualizar nota do estudante ${enrollmentId}:`, error);
            }
        }
    }
    
    showMessage('Notas aplicadas com sucesso!', 'success', 'quickGradeMessage');
    setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('quickGradeModal'));
        modal.hide();
        loadStudents();
        selectedStudents = [];
    }, 1500);
}

function exportGrades() {
    if (!currentModuleId || students.length === 0) {
        showMessage('Nenhum dado para exportar', 'warning');
        return;
    }
    
    // Create CSV content
    const headers = ['Matrícula', 'Nome', 'Faltas', 'Nota Tutor', 'Avaliação', 'Recuperação', 'Final', 'Status'];
    const csvContent = [
        headers.join(','),
        ...students.map(student => {
            const status = getGradeStatus(student.final_grade || 0);
            return [
                student.student_number,
                `"${student.full_name}"`,
                student.absences || 0,
                formatGrade(student.tutor_grade),
                formatGrade(student.regular_exam_grade),
                formatGrade(student.makeup_exam_grade),
                formatGrade(student.final_grade),
                status.text
            ].join(',');
        })
    ].join('\n');
    
    // Download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `notas_modulo_${currentModuleId}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function showMessage(message, type, elementId = 'main') {
    const alertClass = type === 'danger' ? 'alert-danger' : type === 'warning' ? 'alert-warning' : 'alert-success';
    const icon = type === 'danger' ? 'bi-exclamation-triangle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-check-circle';
    
    const html = `
        <div class="alert ${alertClass}">
            <i class="bi ${icon} me-2"></i>${message}
        </div>
    `;
    
    if (elementId === 'main') {
        const contentArea = document.querySelector('.content-area');
        const existingAlert = contentArea.querySelector('.alert');
        if (existingAlert) existingAlert.remove();
        contentArea.insertAdjacentHTML('afterbegin', html);
        
        setTimeout(() => {
            const alert = contentArea.querySelector('.alert');
            if (alert) alert.remove();
        }, 5000);
    } else {
        document.getElementById(elementId).innerHTML = html;
    }
}

function clearMessage(elementId) {
    document.getElementById(elementId).innerHTML = '';
}
</script>
{% endblock %}
